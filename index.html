<script>
  const messagesEl = document.getElementById("messages");
  const inputEl = document.getElementById("input");
  const sendBtn = document.getElementById("send");
  const statusEl = document.getElementById("status");
  const errorEl = document.getElementById("error");
  const resetBtn = document.getElementById("reset");

  // ===== ENDPOINT LOGIC =====
  // Default backend (can be Cloudflare Worker or direct Rasa/ngrok)
  const DEFAULT_ENDPOINT =
    "https://cough-bot-proxy.<ТВІЙ-ID>.workers.dev";

  // Optional override via ?endpoint=https://...
  const params = new URLSearchParams(window.location.search);
  const endpoint = params.get("endpoint") || DEFAULT_ENDPOINT;

  console.log("Using endpoint:", endpoint);

  const senderId = "webchat-user";

  // ===== UI HELPERS =====
  function appendMessage(text, type) {
    const div = document.createElement("div");
    div.className = `msg ${type}`;
    div.textContent = text;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // ===== SEND MESSAGE =====
  async function sendMessage() {
    const text = inputEl.value.trim();
    if (!text) return;

    appendMessage(text, "user");
    inputEl.value = "";
    errorEl.textContent = "";
    statusEl.textContent = "Відправляю…";

    try {
      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          sender: senderId,
          message: text,
        }),
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const data = await res.json();

      if (!data.length) {
        appendMessage("Немає відповіді від бота.", "bot");
      } else {
        data.forEach((msg) => {
          if (msg.text) appendMessage(msg.text, "bot");
        });
      }

      statusEl.textContent = "Готово";
    } catch (err) {
      statusEl.textContent = "Помилка";
      errorEl.textContent = `Помилка запиту: ${err.message}`;
    }
  }

  // ===== RESTART CONVERSATION =====
  async function restartConversation() {
    statusEl.textContent = "Перезапуск…";
    errorEl.textContent = "";

    try {
      await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          sender: senderId,
          message: "/restart",
        }),
      });

      messagesEl.innerHTML = "";
      appendMessage(
        "Починаємо нове опитування. Опишіть симптоми та запитання.",
        "bot"
      );
      statusEl.textContent = "Готово";
    } catch (err) {
      statusEl.textContent = "Помилка";
      errorEl.textContent = `Помилка перезапуску: ${err.message}`;
    }
  }

  // ===== EVENTS =====
  sendBtn.addEventListener("click", sendMessage);
  resetBtn.addEventListener("click", restartConversation);

  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // ===== INIT MESSAGE =====
  appendMessage(
    "Вітаю! Опишіть симптоми, я поставлю уточнення та запропоную діагностичні припущення.",
    "bot"
  );
</script>
